{{- $pages := where site.RegularPages "Draft" false -}}
{{- $index := slice -}}
{{- range $pages -}}
  {{- $tags := or .Params.tags (slice) -}}
  {{- $stack := or .Params.stack (slice) -}}
  {{- $allTags := $tags -}}
  {{- range $stack -}}
    {{- if not (in $tags .) -}}
      {{- $allTags = $allTags | append . -}}
    {{- end -}}
  {{- end -}}
  {{- $entry := dict
    "title" .Title
    "permalink" .Permalink
    "summary" (or .Description .Summary "")
    "section" .Section
    "date" (.Date.Format "2006-01-02")
    "tags" $allTags
  -}}
  {{- $index = $index | append $entry -}}
{{- end -}}
{{- $index | jsonify -}}
