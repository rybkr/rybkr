{{ define "main" }}
<main>
    {{ partial "breadcrumb.html" . }}
    <div class="page-header enter">
        <h1>Projects</h1>
        {{ partial "search-hint.html" . }}
    </div>
    <p class="project-intro enter enter-d1">A selection of work and research.</p>

    {{- $languages := slice "C" "C++" "Python" "Go" "Lua" "JS" -}}
    {{- $domains := slice "Embedded" "Algorithms" "Game Dev" "Web Dev" "Tools" -}}
    {{- $tools := slice "CLI" "Neovim" "Config" "Make" "PlatformIO" -}}

    {{- $pages := .Pages -}}

    {{- /* Count tag occurrences */ -}}
    {{- $tagCounts := dict -}}
    {{- range $pages -}}
        {{- range .Params.tags -}}
            {{- $count := index $tagCounts . | default 0 -}}
            {{- $tagCounts = merge $tagCounts (dict . (add $count 1)) -}}
        {{- end -}}
        {{- range .Params.stack -}}
            {{- $count := index $tagCounts . | default 0 -}}
            {{- $tagCounts = merge $tagCounts (dict . (add $count 1)) -}}
        {{- end -}}
    {{- end -}}

    {{- /* Sort languages by count desc, most recent desc, alpha asc */ -}}
    {{- $sortedLangs := slice -}}
    {{- range $languages -}}
        {{- $tag := . -}}
        {{- $count := index $tagCounts $tag | default 0 -}}
        {{- if gt $count 0 -}}
            {{- $maxUnix := 0 -}}
            {{- range $pages -}}
                {{- $hasTag := false -}}
                {{- range .Params.tags -}}
                    {{- if eq . $tag -}}{{- $hasTag = true -}}{{- end -}}
                {{- end -}}
                {{- range .Params.stack -}}
                    {{- if eq . $tag -}}{{- $hasTag = true -}}{{- end -}}
                {{- end -}}
                {{- if $hasTag -}}
                    {{- $u := int .Date.Unix -}}
                    {{- if gt $u $maxUnix -}}{{- $maxUnix = $u -}}{{- end -}}
                {{- end -}}
            {{- end -}}
            {{- $sortKey := printf "%04d-%010d-%s" (sub 9999 $count) (sub 9999999999 $maxUnix) $tag -}}
            {{- $sortedLangs = $sortedLangs | append (dict "tag" $tag "count" $count "sortKey" $sortKey) -}}
        {{- end -}}
    {{- end -}}
    {{- $sortedLangs = sort $sortedLangs "sortKey" -}}

    {{- $toolsWithCounts := slice -}}
    {{- range $tools -}}
        {{- $count := index $tagCounts . | default 0 -}}
        {{- if gt $count 0 -}}
            {{- $toolsWithCounts = $toolsWithCounts | append (dict "tag" . "count" $count) -}}
        {{- end -}}
    {{- end -}}
    {{- $sortedTools := sort $toolsWithCounts "count" "desc" -}}

    {{- $domainsWithCounts := slice -}}
    {{- range $domains -}}
        {{- $count := index $tagCounts . | default 0 -}}
        {{- if gt $count 0 -}}
            {{- $domainsWithCounts = $domainsWithCounts | append (dict "tag" . "count" $count) -}}
        {{- end -}}
    {{- end -}}
    {{- $sortedDomains := sort $domainsWithCounts "count" "desc" -}}

    <div id="project-filters" class="filter-bar enter enter-d2">
        <div class="filter-group">
            <span class="filter-group-label">Language</span>
            {{- range $sortedLangs -}}
                <button class="filter-pill" data-tag="{{ .tag }}">{{ .tag }}</button>
            {{- end -}}
        </div>
        <div class="filter-group">
            <span class="filter-group-label">Domain</span>
            {{- range $sortedDomains -}}
                <button class="filter-pill" data-tag="{{ .tag }}">{{ .tag }}</button>
            {{- end -}}
        </div>
        <div class="filter-group">
            <span class="filter-group-label">Tools</span>
            {{- range $sortedTools -}}
                <button class="filter-pill" data-tag="{{ .tag }}">{{ .tag }}</button>
            {{- end -}}
        </div>
    </div>

    <p id="no-results" class="no-results" style="display: none;">No projects match the selected filters.</p>

    <section id="projects" class="enter enter-d3">
        {{ range .Pages.ByDate.Reverse }}
        {{- $cardTags := .Params.tags | default slice -}}
        {{- range .Params.stack | default slice -}}
            {{- if not (in $cardTags .) -}}
                {{- $cardTags = $cardTags | append . -}}
            {{- end -}}
        {{- end -}}
        <article class="project-card" data-tags="{{ $cardTags | jsonify }}">
            <div class="card-left">
                {{- $projectURL := "" -}}
                {{- $isExternal := false -}}
                {{- if .Params.redirect -}}
                    {{- $projectURL = .Params.redirect -}}
                    {{- $isExternal = true -}}
                {{- else if .Params.github -}}
                    {{- $projectURL = .Params.github -}}
                    {{- $isExternal = true -}}
                {{- else if .Content -}}
                    {{- $projectURL = .RelPermalink -}}
                {{- else -}}
                    {{- $projectURL = printf "https://github.com/rybkr/%s" .File.ContentBaseName -}}
                    {{- $isExternal = true -}}
                {{- end -}}
                <h2>
                    <a href="{{ $projectURL }}"{{ if $isExternal }} target="_blank" rel="noopener"{{ end }}>
                        {{ .Title }}
                    </a>
                    {{- if .Params.wip -}}
                    <span class="wip-badge">WIP</span>
                    {{- end -}}
                </h2>

                {{ with .Params.subtitle }}
                <p class="project-card-subtitle">{{ . }}</p>
                {{ end }} {{ $stack := .Params.stack | default slice }} {{ $tags
                := .Params.tags | default slice }} {{ $allTags := slice }} {{
                range $stack }} {{ $allTags = $allTags | append . }} {{ end }}
                {{ range $tags }} {{ if not (in $stack .) }} {{ $allTags =
                $allTags | append . }} {{ end }} {{ end }} {{ $tagIcons := dict
                "go" "/icons/tags/go.svg" "c" "/icons/tags/c.svg" "js"
                "/icons/tags/js.svg" "html" "/icons/tags/html.svg" "css"
                "/icons/tags/css.svg" "cli" "/icons/tags/term.svg" "c++"
                "/icons/tags/cpp.svg" "git" "/icons/tags/git.svg" "python"
                "/icons/tags/python.svg" "lua" "/icons/tags/lua.svg" "sql"
                "/icons/tags/sql.svg" "neovim" "/icons/tags/nvim.svg" }}

                <div class="tag-row">
                    {{ range $allTags }} {{ $tag := lower . }} {{ $icon := index
                    $tagIcons $tag }}
                    <span class="tag-pill">
                        {{ if $icon }}
                        <img src="{{ $icon }}" alt="{{ . }} icon" />
                        {{ end }}
                        <span class="tag-label">{{ . }}</span>
                    </span>
                    {{ end }}
                </div>
            </div>

            <div class="card-middle">
                {{ with .Params.summary }} {{ if ne . "" }}
                <p>{{ . }}</p>
                {{ end }} {{ end }}
            </div>

            <div class="card-right">
                {{ with .Params.thumbnail }}
                <img
                    class="project-thumb"
                    src="{{ . }}"
                    alt="{{ $.Title }} thumbnail"
                />
                {{ end }}
            </div>
        </article>

        {{ end }}
    </section>
</main>
<script src="/js/projects-filter.js"></script>
{{ end }}
